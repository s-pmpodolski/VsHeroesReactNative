<html>
    <head>
        <title>Test restify</title>
        <script src="http://fb.me/react-with-addons-0.12.2.js"></script>
        <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
        <!-- <link rel="stylesheet" href="http://getbootstrap.com/examples/dashboard/dashboard.css"> -->
        <script src="../dist/restful.min.js"></script>
    </head>
    <body>

        <nav class="navbar navbar-inverse navbar-fixed-top">
          <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Project name</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
              <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Profile</a></li>
                <li><a href="#">Help</a></li>
              </ul>
            </div>
          </div>
        </nav>

        <div class="container-fluid" id="container"></div>

        <script type="text/jsx">
            var Member = React.createClass({
                getInitialState: function() {
                    var entityData = this.props.entity.data();

                    var data = {};

                    for (var i in entityData) {
                        data[i] = entityData[i];
                    }

                    return {
                        data: entityData,
                        waitForFlushing: false,
                        isPending: false
                    };
                },
                componentDidMount: function() {
                    this.interval = setInterval(this._flush, 2000);
                },
                componentWillUnmount: function() {
                    clearInterval(this.interval);
                },
                render: function() {
                    var data = this.props.entity.data();

                    var isPending = this.state.isPending;
                    var text;

                    var fragments = this.props.entity.url().split('/');
                    var name = fragments[fragments.length - 2].substring(0, fragments[fragments.length - 2].length - 1);

                    if (!isPending) {
                        text = 'Save';
                    } else {
                        text = 'Saving...';
                    }

                    var fields = [];

                    for (var i in data) {
                        if (i === 'body' || i === 'text' || i === 'content') {
                            fields.push(
                                <div className="form-group">
                                    <label htmlFor={i} className="col-sm-3 control-label">{i}</label>
                                    <div className="col-sm-9">
                                        <textarea onChange={this._onChange(i)} className="textarea form-control" row="3" id={i} placeholder={i} defaultValue={data[i]} disabled={isPending || i === 'id'} key={i + data.id}></textarea>
                                    </div>
                                </div>
                            );

                            continue;
                        }

                        fields.push(
                            <div className="form-group">
                                <label htmlFor={i} className="col-sm-3 control-label">{i}</label>
                                <div className="col-sm-9">
                                    <input type="text" onChange={this._onChange(i)} className="form-control" id={i} placeholder={i} defaultValue={data[i]} disabled={isPending || i === 'id'} />
                                </div>
                            </div>
                        );
                    }
                    return (
                        <div className="col-sm-6 col-md-4">
                            <div className="panel panel-default">
                                <div className="panel-heading">
                                    {name} #{data.id}
                                </div>
                                <div className="panel-body">
                                    <form className="form-horizontal">
                                        {fields}
                                    </form>
                                </div>
                                <div className="panel-footer">
                                    <div className="btn-group">
                                        <button onClick={this._onSaveClick} className="btn btn-primary" disabled={isPending} type="button">
                                            <span className="glyphicon glyphicon-save"></span>{text}
                                        </button>
                                        <button onClick={this._onRemoveClick} className="btn btn-danger" type="button">
                                            <span className="glyphicon glyphicon-trash"></span> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                },
                _onChange: function(field) {
                    var self = this;

                    return function(event) {
                        self.state.data[field] = event.target.value;
                        self.state.waitForFlushing = true;

                        self.setState(self.state);
                    };
                },
                _onSaveClick: function() {
                    this.state.waitForFlushing = true;

                    this.setState(this.state);
                    this._flush();
                },
                _flush: function() {
                    if (this.state.waitForFlushing) {
                        for (var i in this.state.data) {
                            this.props.entity.data()[i] = this.state.data[i];
                        }

                        this.state.waitForFlushing = false;
                        this.state.isPending = true;

                        this.setState(this.state);

                        var self = this;
                        return this.props.entity.save().then(function() {
                            self.state.isPending = false;

                            self.setState(self.state);
                        });
                    }
                },
                _onRemoveClick: function() {
                    var self = this;
                    this.props.entity.remove().then(function() {
                        self.props.collection._getAll();
                    });
                }
            });

            var Collection = React.createClass({
                _getAll: function() {
                    var self = this;

                    this.props.resource
                        .getAll()
                        .then(function(response) {
                            self.setState({
                                members: response.body()
                            });
                        }, function(response) {
                            console.log(response);
                        });
                },
                _onCreateClick: function() {
                    var data = {};

                    if (this.state.members.length) {
                        Object.keys(this.state.members[this.state.members.length - 1].data()).map(function(field) {
                            if (field === 'id') {
                                return;
                            }

                            data[field] = "";
                        });
                    }

                    this.props.resource
                        .post(data)
                        .then(this._getAll);
                },
                getInitialState: function() {
                    return { members: [] };
                },
                componentDidMount: function() {
                    this._getAll();
                },
                render: function() {
                    var self = this;
                    var memberNodes = this.state.members.map(function (member, index) {
                        return <Member entity={member} collection={self} key={member.id()}/>;
                    });

                    var fragments = this.props.resource.url().split('/');
                    var name = fragments[fragments.length - 1];

                    return (
                        <div>
                            <div className="row">
                                <div className="page-header">
                                    <h1>
                                        {name} collection
                                        <button className="btn btn-primary pull-right" onClick={this._onCreateClick}>
                                            <span className="glyphicon glyphicon-plus"></span> New
                                        </button>
                                    </h1>


                                </div>
                            </div>
                            <div className="row">
                                {memberNodes}
                            </div>
                        </div>
                    );
                }
            });

             var Api = React.createClass({
                getInitialState: function() {
                    return {
                        api: restful(this.props.host, parseInt(this.props.port)),
                        activeCollection: this.props.collections[0]
                    };
                },
                componentDidMount: function() {
                    this.state.api.addRequestInterceptor(function(data, headers) {console.log(arguments);
                        headers.help = "oh yeah";

                        return data;
                    });
                },
                render: function() {
                    var self = this;
                    var cx = React.addons.classSet;
                    var collections = this.props.collections.map(function(collectionName) {
                        var className = 'glyphicon glyphicon-th-list glyphicon-' + collectionName;

                        return (
                            <li className={cx({active: self.state.activeCollection === collectionName})} >
                                <a href="#" onClick={self._onCollectionClick(collectionName)}>
                                    <div style={{display: 'inline-block', 'padding-right': '10px'}}>
                                        <span className={className}></span>
                                    </div>
                                    {collectionName}
                                </a>
                            </li>
                        );
                    });

                    return (
                        <div className="row">
                            <div className="col-sm-3 col-md-2 sidebar">
                                <ul className="nav nav-sidebar">
                                    {collections}
                                </ul>
                            </div>
                            <div className="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                                <Collection resource={this.state.api.all(this.state.activeCollection)} key={this.state.activeCollection}/>
                            </div>
                        </div>
                    );
                },
                _onCollectionClick: function(collectionName) {
                    var self = this;

                    return function() {
                        self.state.activeCollection = collectionName;
                        self.setState(self.state);
                    }
                }
            });

            React.render(
              <Api host="localhost" port="3000" collections={['posts', 'tags']} />,
              document.getElementById('container')
            );
        </script>
    </body>
</html>
